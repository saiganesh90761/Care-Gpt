{% extends "base.html" %}
{% block title %}Generate EHR – HealthApp AI{% endblock %}
{% block content %}
<div class="page-header">
    <h1 class="page-title">Generate Health Record (EHR)</h1>
    <p class="page-desc">Create a digital summary of your current condition to share with your doctor.</p>
</div>

<div class="dash-grid" style="grid-template-columns: 1fr 1fr; align-items: start;">

    <!-- Input Form -->
    <div class="card">
        <div class="card-header" style="border-bottom:1px solid var(--color-border); padding:1rem;">
            <h3 class="card-title">Patient Details</h3>
        </div>
        <div class="card-body">
            <form id="ehr-form">
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Name</label>
                        <input type="text" id="p_name" class="form-input" value="{{ user.full_name }}" readonly>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Date</label>
                        <input type="date" id="p_date" class="form-input">
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Age</label>
                        <input type="number" id="p_age" class="form-input" value="30">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Gender</label>
                        <select id="p_gender" class="form-select">
                            <option value="Male">Male</option>
                            <option value="Female">Female</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">Symptoms</label>
                    <textarea id="p_symptoms" class="form-textarea" rows="3"
                        placeholder="Describe your symptoms..."></textarea>
                </div>

                <div class="form-row form-row-3">
                    <div class="form-group">
                        <label class="form-label">BP (mmHg)</label>
                        <input type="text" id="p_bp" class="form-input" placeholder="120/80">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Heart Rate</label>
                        <input type="number" id="p_hr" class="form-input" placeholder="72">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Temp (°C)</label>
                        <input type="number" id="p_temp" class="form-input" placeholder="36.6">
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">Pre-existing Conditions</label>
                    <input type="text" id="p_conditions" class="form-input" placeholder="Diabetes, Hypertension...">
                </div>

                <div class="form-actions" style="margin-top:1rem;">
                    <button type="button" onclick="updatePreview()" class="btn-primary" style="width:100%;">Generate
                        Preview</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Preview & Download -->
    <div style="display:flex; flex-direction:column; gap:1rem;">

        <!-- The Card to Capture -->
        <div id="ehr-preview"
            style="background:#fff; padding:2rem; border-radius:12px; border:1px solid #e0e0e0; font-family:'Inter', sans-serif; color:#333;">
            <!-- Header -->
            <div
                style="border-bottom:2px solid #0f766e; padding-bottom:1rem; margin-bottom:1.5rem; display:flex; justify-content:space-between; align-items:center;">
                <div>
                    <h2 style="margin:0; color:#0f766e; font-size:1.5rem;">Health Record Summary</h2>
                    <p style="margin:0.25rem 0 0; color:#666; font-size:0.875rem;">Generated by HealthApp AI</p>
                </div>
                <div style="text-align:right;">
                    <p id="view-date" style="margin:0; font-weight:600; font-size:1rem;">--</p>
                    <p style="margin:0; font-size:0.75rem; color:#999;">Report ID: <span id="view-id">--</span></p>
                </div>
            </div>

            <!-- Patient Info -->
            <div
                style="background:#f0fdfa; padding:1rem; border-radius:8px; margin-bottom:1.5rem; display:grid; grid-template-columns:1fr 1fr; gap:1rem;">
                <div>
                    <p
                        style="margin:0; font-size:0.75rem; color:#0f766e; text-transform:uppercase; letter-spacing:0.5px;">
                        Patient Name</p>
                    <p id="view-name" style="margin:0.25rem 0 0; font-size:1.1rem; font-weight:600;">--</p>
                </div>
                <div>
                    <p
                        style="margin:0; font-size:0.75rem; color:#0f766e; text-transform:uppercase; letter-spacing:0.5px;">
                        Demographics</p>
                    <p style="margin:0.25rem 0 0; font-size:1rem;"><span id="view-age">--</span> yo / <span
                            id="view-gender">--</span></p>
                </div>
            </div>

            <!-- Vitals -->
            <p
                style="margin:0 0 0.5rem; font-size:0.875rem; font-weight:bold; color:#333; text-transform:uppercase; border-bottom:1px solid #eee; padding-bottom:0.25rem;">
                Vitals</p>
            <div style="display:grid; grid-template-columns:1fr 1fr 1fr; gap:1rem; margin-bottom:1.5rem;">
                <div style="background:#f9fafb; padding:0.75rem; border-radius:6px; text-align:center;">
                    <span style="display:block; font-size:0.75rem; color:#666;">BP</span>
                    <span id="view-bp" style="font-weight:700; font-size:1.1rem; color:#111;">--</span>
                    <span style="font-size:0.75rem; color:#999;">mmHg</span>
                </div>
                <div style="background:#f9fafb; padding:0.75rem; border-radius:6px; text-align:center;">
                    <span style="display:block; font-size:0.75rem; color:#666;">Heart Rate</span>
                    <span id="view-hr" style="font-weight:700; font-size:1.1rem; color:#111;">--</span>
                    <span style="font-size:0.75rem; color:#999;">bpm</span>
                </div>
                <div style="background:#f9fafb; padding:0.75rem; border-radius:6px; text-align:center;">
                    <span style="display:block; font-size:0.75rem; color:#666;">Temp</span>
                    <span id="view-temp" style="font-weight:700; font-size:1.1rem; color:#111;">--</span>
                    <span style="font-size:0.75rem; color:#999;">°C</span>
                </div>
            </div>

            <!-- Clinical -->
            <p
                style="margin:0 0 0.5rem; font-size:0.875rem; font-weight:bold; color:#333; text-transform:uppercase; border-bottom:1px solid #eee; padding-bottom:0.25rem;">
                Clinical Details</p>

            <div style="margin-bottom:1rem;">
                <p style="margin:0 0 0.25rem; font-size:0.8rem; color:#666;">Reported Symptoms</p>
                <div id="view-symptoms"
                    style="padding:0.75rem; background:#fff; border:1px solid #ddd; border-left:4px solid #f59e0b; border-radius:4px; font-size:0.95rem; line-height:1.5;">
                    --
                </div>
            </div>

            <div style="margin-bottom:0;">
                <p style="margin:0 0 0.25rem; font-size:0.8rem; color:#666;">History</p>
                <p id="view-conditions" style="margin:0; font-size:0.95rem;">--</p>
            </div>

            <!-- Footer -->
            <div
                style="margin-top:2rem; padding-top:1rem; border-top:1px solid #eee; text-align:center; font-size:0.7rem; color:#aaa;">
                Generated on <span id="view-generated-time"></span> • Review with a medical professional.
            </div>
        </div>

        <!-- Download Button -->
        <button onclick="downloadEHR()" class="btn-success"
            style="padding:1rem; display:flex; justify-content:center; align-items:center; gap:0.5rem; box-shadow:var(--shadow-md);">
            <span class="material-symbols-outlined">download</span> Download Image for Doctor
        </button>

        <p style="font-size:0.875rem; color:var(--color-text-muted); text-align:center;">Save this image to your phone
            and show it to your doctor during the appointment.</p>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script>
    // Set default date
    document.getElementById('p_date').valueAsDate = new Date();

    function updatePreview() {
        document.getElementById('view-date').textContent = new Date(document.getElementById('p_date').value).toLocaleDateString();
        document.getElementById('view-id').textContent = Math.random().toString(36).substr(2, 9).toUpperCase();
        document.getElementById('view-name').textContent = document.getElementById('p_name').value || 'Anonymous';
        document.getElementById('view-age').textContent = document.getElementById('p_age').value || '--';
        document.getElementById('view-gender').textContent = document.getElementById('p_gender').value;

        document.getElementById('view-bp').textContent = document.getElementById('p_bp').value || '--/--';
        document.getElementById('view-hr').textContent = document.getElementById('p_hr').value || '--';
        document.getElementById('view-temp').textContent = document.getElementById('p_temp').value || '--';

        document.getElementById('view-symptoms').textContent = document.getElementById('p_symptoms').value || 'None reported.';
        document.getElementById('view-conditions').textContent = document.getElementById('p_conditions').value || 'None';

        document.getElementById('view-generated-time').textContent = new Date().toLocaleString();
    }

    function downloadEHR() {
        var element = document.getElementById('ehr-preview');

        // Ensure preview looks good (update it first)
        updatePreview();

        html2canvas(element, { scale: 2 }).then(canvas => {
            var link = document.createElement('a');
            link.download = 'Health_Record_' + new Date().toISOString().slice(0, 10) + '.png';
            link.href = canvas.toDataURL();
            link.click();
        });
    }

    // Initial run
    updatePreview();
</script>
{% endblock %}