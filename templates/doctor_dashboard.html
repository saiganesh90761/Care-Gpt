{% extends "base.html" %}
{% block title %}Doctor Dashboard â€“ HealthApp AI{% endblock %}
{% block content %}
<div class="page-header">
    <h1 class="page-title">Doctor Dashboard</h1>
    <p class="page-desc">Manage your patients, appointments, and prescriptions.</p>
</div>

<div class="dash-grid">
    <div class="dash-main">

        <!-- Patient Management -->
        <section class="card" style="margin-bottom: 2rem;">
            <div class="card-body">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:1rem;">
                    <div style="display:flex; gap:1rem; align-items:center;">
                        <h2 class="card-title">My Patients</h2>
                        <button onclick="openProfileModal()" class="btn-upload" style="font-size:0.8rem;">
                            <span class="material-symbols-outlined" style="font-size:1rem">edit_note</span> Edit Profile
                        </button>
                    </div>
                    <button onclick="generateInvite()" class="btn-primary"
                        style="font-size:0.875rem; padding:0.5rem 1rem;">
                        <span class="material-symbols-outlined" style="font-size:1rem">person_add</span> Invite Patient
                    </button>
                </div>

                <!-- Profile Modal -->
                <dialog id="profile-modal"
                    style="border:none; border-radius:12px; padding:0; box-shadow:var(--shadow-lg); width:100%; max-width:500px;">
                    <div class="card-body">
                        <h3 class="card-title">Professional Profile</h3>
                        <form action="/doctor/profile/update" method="POST">
                            <div class="form-group">
                                <label class="form-label">Qualifications</label>
                                <input type="text" name="qualifications" class="form-input"
                                    placeholder="e.g. MBBS, MD (Cardiology)" value="{{ profile.qualifications or '' }}">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Hospital / Clinic</label>
                                <input type="text" name="hospital_name" class="form-input" placeholder="Hospital Name"
                                    value="{{ profile.hospital_name or '' }}">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Contact Number</label>
                                <input type="text" name="contact_phone" class="form-input" placeholder="Work Phone"
                                    value="{{ profile.contact_phone or '' }}">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Address</label>
                                <input type="text" name="address" class="form-input" placeholder="Clinic Address"
                                    value="{{ profile.address or '' }}">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Bio</label>
                                <textarea name="bio" class="form-textarea" rows="3"
                                    placeholder="Brief professional bio...">{{ profile.bio or '' }}</textarea>
                            </div>
                            <div class="form-actions" style="display:flex; justify-content:flex-end; gap:0.5rem;">
                                <button type="button" onclick="document.getElementById('profile-modal').close()"
                                    class="btn-upload">Cancel</button>
                                <button type="submit" class="btn-primary">Save Profile</button>
                            </div>
                        </form>
                    </div>
                </dialog>

                {% if patients %}
                <div class="table-responsive">
                    <table style="width:100%; border-collapse:collapse;">
                        <thead>
                            <tr style="text-align:left; border-bottom:1px solid var(--color-border);">
                                <th style="padding:0.75rem;">Name</th>
                                <th style="padding:0.75rem;">Email</th>
                                <th style="padding:0.75rem;">Status</th>
                                <th style="padding:0.75rem;">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for p in patients %}
                            <tr style="border-bottom:1px solid var(--color-border);">
                                <td style="padding:0.75rem;">{{ p.full_name }}</td>
                                <td style="padding:0.75rem; color:var(--color-text-muted);">{{ p.email }}</td>
                                <td style="padding:0.75rem;">
                                    <span class="badge badge-low">{{ p.status }}</span>
                                </td>
                                <td style="padding:0.75rem;">
                                    <button onclick="openPrescriptionModal('{{ p.id }}', '{{ p.full_name }}')"
                                        class="btn-upload"
                                        style="font-size:0.75rem; padding:0.3rem 0.6rem;">Prescribe</button>
                                    <a href="/doctor/monitor/{{ p.id }}" class="btn-secondary"
                                        style="font-size:0.75rem; padding:0.3rem 0.6rem; text-decoration:none;">
                                        Monitor
                                    </a>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <p class="empty-state">No patients linked yet. Invite patients to join your workspace.</p>
                {% endif %}
            </div>
        </section>

        <!-- Analytics Section -->
        <section class="card" style="margin-bottom: 2rem;">
            <div class="card-body">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:1.5rem;">
                    <h2 class="card-title">
                        <span class="material-symbols-outlined" style="color:var(--color-primary)">analytics</span>
                        Dataset Analytics
                    </h2>
                    <button onclick="loadAnalytics()" class="btn-upload" style="font-size:0.8rem;">Refresh Data</button>
                </div>

                <div id="analytics-loader" style="text-align:center; padding:2rem; color:var(--color-text-muted);">
                    Loading analytics...
                </div>

                <div id="analytics-content" style="display:none;">
                    <!-- Top Stats Row -->
                    <div
                        style="display:grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap:1rem; margin-bottom:2rem;">
                        <div class="stat-card">
                            <h4 style="font-size:0.875rem; color:var(--color-text-muted); margin-bottom:0.5rem;">Most
                                Common Risk</h4>
                            <div class="stat-value" id="top-risk" style="font-size:1.5rem;">--</div>
                        </div>
                        <div class="stat-card">
                            <h4 style="font-size:0.875rem; color:var(--color-text-muted); margin-bottom:0.5rem;">Top
                                Department</h4>
                            <div class="stat-value" id="top-dept" style="font-size:1.5rem;">--</div>
                        </div>
                        <div class="stat-card">
                            <h4 style="font-size:0.875rem; color:var(--color-text-muted); margin-bottom:0.5rem;">Top
                                Symptom</h4>
                            <div class="stat-value" id="top-sym" style="font-size:1.5rem;">--</div>
                        </div>
                    </div>

                    <!-- Charts Grid -->
                    <div style="display:grid; grid-template-columns: 1fr; gap:2rem;">
                        <div
                            style="display:grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap:2rem;">
                            <!-- Risk Dist -->
                            <div>
                                <h4 style="font-size:1rem; font-weight:700; margin-bottom:1rem; text-align:center;">Risk
                                    Distribution</h4>
                                <div style="height:250px; position:relative;">
                                    <canvas id="riskChart"></canvas>
                                </div>
                            </div>
                            <!-- Age Dist -->
                            <div>
                                <h4 style="font-size:1rem; font-weight:700; margin-bottom:1rem; text-align:center;">Age
                                    Demographics</h4>
                                <div style="height:250px; position:relative;">
                                    <canvas id="ageChart"></canvas>
                                </div>
                            </div>
                        </div>

                        <!-- Dept Dist -->
                        <div>
                            <h4 style="font-size:1rem; font-weight:700; margin-bottom:1rem;">Department Recommendations
                            </h4>
                            <div style="height:300px; position:relative;">
                                <canvas id="deptChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>


        <!-- Prescription Modal (Dynamic Multi-Row) -->
        <dialog id="prescription-modal"
            style="border:none; border-radius:12px; padding:0; box-shadow:var(--shadow-lg); width:100%; max-width:600px;">
            <div class="card-body">
                <h3 class="card-title">Add Prescription</h3>
                <p id="modal-patient-name" style="margin-bottom:1rem; color:var(--color-text-muted);"></p>
                <form action="{{ url_for('add_prescription') }}" method="POST">
                    <input type="hidden" name="patient_id" id="modal-patient-id">

                    <div id="med-container">
                        <!-- Med Row Template -->
                        <div class="med-row"
                            style="background:var(--color-surface-dim); padding:1rem; border-radius:8px; margin-bottom:1rem; position:relative;">
                            <h4 style="margin:0 0 0.5rem 0; font-size:0.875rem; color:var(--color-text-muted);">
                                Medication 1</h4>
                            <div class="form-group">
                                <label class="form-label">Medication Name</label>
                                <input type="text" name="medication_name[]" class="form-input" required
                                    placeholder="e.g. Amoxicillin">
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">Dosage</label>
                                    <input type="text" name="dosage[]" class="form-input" placeholder="e.g. 500mg">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Frequency</label>
                                    <input type="text" name="frequency[]" class="form-input"
                                        placeholder="e.g. 2x daily">
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Instructions / Description</label>
                                <textarea name="instructions[]" class="form-textarea" rows="2"
                                    placeholder="e.g. Take with food. Avoid alcohol."></textarea>
                            </div>
                        </div>
                    </div>

                    <button type="button" onclick="addMedRow()" class="btn-text"
                        style="width:100%; margin-bottom:1rem; border:1px dashed var(--color-border);">
                        + Add Another Medication
                    </button>

                    <div class="form-actions" style="display:flex; justify-content:flex-end; gap:0.5rem;">
                        <button type="button" onclick="document.getElementById('prescription-modal').close()"
                            class="btn-upload">Cancel</button>
                        <button type="submit" class="btn-primary">Prescribe All</button>
                    </div>
                </form>
            </div>
        </dialog>

        <!-- Invite Modal -->
        <dialog id="invite-modal"
            style="border:none; border-radius:12px; padding:0; box-shadow:var(--shadow-lg); width:100%; max-width:400px;">
            <div class="card-body" style="text-align:center;">
                <h3 class="card-title" style="justify-content:center;">Invite Patient</h3>
                <p>Share this link with your patient:</p>
                <div style="background:var(--color-surface-dim); padding:1rem; border-radius:8px; margin:1rem 0; word-break:break-all; font-family:monospace;"
                    id="invite-link">
                    Generating...
                </div>
                <button onclick="document.getElementById('invite-modal').close()" class="btn-primary">Close</button>
            </div>
        </dialog>

        <!-- Availability Slots Modal (NEW) -->
        <dialog id="slots-modal"
            style="border:none; border-radius:12px; padding:0; box-shadow:var(--shadow-lg); width:100%; max-width:400px;">
            <div class="card-body">
                <h3 class="card-title">Set Availability</h3>
                <p style="font-size:0.875rem; color:var(--color-text-muted);">Choose a date and times you are free.</p>
                <form action="/doctor/slots" method="POST">
                    <div class="form-group">
                        <label class="form-label">Date</label>
                        <input type="date" name="date" class="form-input" required id="slot-date">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Max Patients per Slot</label>
                        <input type="number" name="capacity" class="form-input" value="1" min="1" max="10" required>
                        <p style="font-size:0.75rem; color:var(--color-text-muted);">How many patients can book this
                            time?</p>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Times (Select multiple)</label>
                        <div
                            style="display:grid; grid-template-columns:1fr 1fr 1fr; gap:0.5rem; max-height:200px; overflow-y:auto; border:1px solid var(--color-border); padding:0.5rem; border-radius:8px;">
                            {% for h in range(8, 18) %}
                            <label style="display:flex; align-items:center; gap:0.25rem; font-size:0.875rem;">
                                <input type="checkbox" name="times" value="{{ '%02d' % h }}:00"> {{ '%02d' % h }}:00
                            </label>
                            <label style="display:flex; align-items:center; gap:0.25rem; font-size:0.875rem;">
                                <input type="checkbox" name="times" value="{{ '%02d' % h }}:30"> {{ '%02d' % h }}:30
                            </label>
                            {% endfor %}
                        </div>
                    </div>
                    <div class="form-actions" style="display:flex; justify-content:flex-end; gap:0.5rem;">
                        <button type="button" onclick="document.getElementById('slots-modal').close()"
                            class="btn-upload">Cancel</button>
                        <button type="submit" class="btn-primary">Create Slots</button>
                    </div>
                </form>
            </div>
        </dialog>

    </div>

    <!-- Sidebar: Appointments -->
    <aside class="dash-side">
        <div class="side-card">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <h3 class="side-card-title">Appointments</h3>
                <button onclick="openSlotsModal()" class="btn-icon" title="Set Availability"
                    style="color:var(--color-primary);">
                    <span class="material-symbols-outlined">calendar_add_on</span>
                </button>
            </div>

            {% if appointments %}
            <ul class="recent-list" style="margin-top:1rem;">
                {% for apt in appointments %}
                <li class="recent-item" style="display:block;">
                    <div style="display:flex; justify-content:space-between; margin-bottom:0.25rem;">
                        <span style="font-weight:700;">{{ apt.other_name }}</span>
                        <div style="display:flex; align-items:center; gap:0.5rem;">
                            <span class="badge badge-medium">{{ apt.appointment_time | replace('T', ' ') }}</span>
                            <form action="{{ url_for('cancel_appointment', appointment_id=apt.id) }}" method="POST"
                                style="margin:0;"
                                onsubmit="return confirm('Cancel appointment with {{ apt.other_name }}?');">
                                <button type="submit"
                                    style="color:var(--color-danger); background:none; border:none; cursor:pointer;"
                                    title="Cancel">
                                    <span class="material-symbols-outlined" style="font-size:1.1rem;">delete</span>
                                </button>
                            </form>
                        </div>
                    </div>
                    <div style="margin-top:0.25rem;">
                        <p style="font-size:0.875rem; color:var(--color-text-muted); margin:0;">{{ apt.notes or 'No
                            notes' }}</p>
                        {% if apt.ehr_file %}
                        <a href="{{ url_for('uploaded_file', filename=apt.ehr_file) }}" target="_blank"
                            style="display:inline-flex; align-items:center; gap:0.25rem; font-size:0.8rem; color:var(--color-primary); margin-top:0.25rem; text-decoration:none;">
                            <span class="material-symbols-outlined" style="font-size:1rem;">attachment</span> View EHR
                        </a>
                        {% endif %}
                    </div>
                </li>
                {% endfor %}
            </ul>
            {% else %}
            <p class="empty-state" style="font-size:0.875rem;">No appointments booked yet.</p>
            {% endif %}
        </div>
    </aside>
</div>

<script>
    // --- Prescription Logic ---
    function openPrescriptionModal(id, name) {
        document.getElementById('modal-patient-id').value = id;
        document.getElementById('modal-patient-name').textContent = 'For: ' + name;
        // Reset to one row
        document.getElementById('med-container').innerHTML = '';
        addMedRow();
        document.getElementById('prescription-modal').showModal();
    }

    function addMedRow() {
        var container = document.getElementById('med-container');
        var idx = container.children.length + 1;
        var div = document.createElement('div');
        div.className = 'med-row';
        div.style.cssText = 'background:var(--color-surface-dim); padding:1rem; border-radius:8px; margin-bottom:1rem; position:relative;';
        div.innerHTML = `
            <div style="position:absolute; top:0.5rem; right:0.5rem; cursor:pointer; color:var(--color-text-muted);" onclick="this.parentElement.remove()">
                <span class="material-symbols-outlined" style="font-size:1.1rem">close</span>
            </div>
            <h4 style="margin:0 0 0.5rem 0; font-size:0.875rem; color:var(--color-text-muted);">Medication ${idx}</h4>
            <div class="form-group">
                <input type="text" name="medication_name[]" class="form-input" required placeholder="Medication Name">
            </div>
            <div class="form-row">
                <div class="form-group">
                    <input type="text" name="dosage[]" class="form-input" placeholder="Dosage">
                </div>
                <div class="form-group">
                    <input type="text" name="frequency[]" class="form-input" placeholder="Frequency">
                </div>
            </div>
            <div class="form-group">
                <textarea name="instructions[]" class="form-textarea" rows="2" placeholder="Instructions used to be plain..."></textarea>
            </div>
        `;
        container.appendChild(div);
    }

    // --- Invite Logic ---
    function generateInvite() {
        document.getElementById('invite-modal').showModal();
        document.getElementById('invite-link').textContent = 'Generating...';

        fetch('/doctor/invite', { method: 'POST' })
            .then(r => r.json())
            .then(data => {
                document.getElementById('invite-link').textContent = data.link;
            })
            .catch(err => {
                document.getElementById('invite-link').textContent = 'Error generating link';
            });
    }

    // --- Slots Logic ---
    function openSlotsModal() {
        // Default to today
        document.getElementById('slot-date').valueAsDate = new Date();
        document.getElementById('slots-modal').showModal();
    }
</script>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    // --- Analytics Logic ---
    var riskChart, deptChart, ageChart;

    function loadAnalytics() {
        document.getElementById('analytics-loader').style.display = 'block';
        document.getElementById('analytics-content').style.display = 'none';

        fetch('/api/doctor/stats')
            .then(function (r) { return r.json(); })
            .then(function (data) {
                if (data.error) {
                    document.getElementById('analytics-loader').innerText = 'Error: ' + data.error;
                    return;
                }

                document.getElementById('analytics-loader').style.display = 'none';
                document.getElementById('analytics-content').style.display = 'block';

                // Top Stats (find max keys)
                var topRisk = Object.entries(data.risk_distribution).sort((a, b) => b[1] - a[1])[0] || ['--', 0];
                var topDept = Object.entries(data.dept_distribution).sort((a, b) => b[1] - a[1])[0] || ['--', 0];
                var topSym = data.top_symptoms[0] ? [data.top_symptoms[0].label, data.top_symptoms[0].value] : ['--', 0];

                document.getElementById('top-risk').innerText = topRisk[0];
                document.getElementById('top-dept').innerText = topDept[0];
                document.getElementById('top-sym').innerText = topSym[0];

                // Render Charts
                renderRiskChart(data.risk_distribution);
                renderDeptChart(data.dept_distribution);
                renderAgeChart(data.age_distribution);
            })
            .catch(function (err) {
                console.error(err);
                document.getElementById('analytics-loader').innerText = 'Failed to load data.';
            });
    }

    function renderRiskChart(dist) {
        var ctx = document.getElementById('riskChart').getContext('2d');
        if (riskChart) riskChart.destroy();

        var labels = Object.keys(dist);
        var values = Object.values(dist);
        var colors = labels.map(l => l === 'High' ? '#dc2626' : l === 'Medium' ? '#d97706' : '#059669');

        riskChart = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: labels,
                datasets: [{
                    data: values,
                    backgroundColor: colors,
                    borderWidth: 0
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { position: 'bottom' }
                }
            }
        });
    }

    function renderDeptChart(dist) {
        var ctx = document.getElementById('deptChart').getContext('2d');
        if (deptChart) deptChart.destroy();

        // Sort by count
        var sorted = Object.entries(dist).sort((a, b) => b[1] - a[1]).slice(0, 8); // Top 8
        var labels = sorted.map(x => x[0]);
        var values = sorted.map(x => x[1]);

        deptChart = new Chart(ctx, {
            type: 'bar',
            indexAxis: 'y',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Patients',
                    data: values,
                    backgroundColor: '#0f766e',
                    borderRadius: 4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: { x: { beginAtZero: true } }
            }
        });
    }

    function renderAgeChart(dist) {
        var ctx = document.getElementById('ageChart').getContext('2d');
        if (ageChart) ageChart.destroy();

        var labels = Object.keys(dist);
        var values = Object.values(dist);

        ageChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Age Group',
                    data: values,
                    backgroundColor: '#3b82f6',
                    borderRadius: 4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: { y: { beginAtZero: true } }
            }
        });
    }

    // Auto load on open
    document.addEventListener('DOMContentLoaded', loadAnalytics);

    function openProfileModal() {
        document.getElementById('profile-modal').showModal();
    }
</script>
{% endblock %}